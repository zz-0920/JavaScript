# TCP 协议

## 主要特性
1. 面向有连接
2. 可靠的
3. 有序的

## TCP头部结构
1. Sequence Number 序列号
2. Acknowledgment Number 确认号
3. Data offset 数据偏移量
4. Reserved 保留位
5. Flags 标志符
   - SYN 同步标志位 (值为0或1，用于请求建立连接)
   - ACK 确认标志位 (值为0或1，用于确认收到数据)
   - PSH 推送标志位 (值为0或1，用于立即推送数据)
   - FIN 结束标志位 (值为0或1，用于请求关闭连接)
   - RST 重置标志位 (值为0或1，用于重置连接)
   - URG 紧急标志位 (值为0或1，用于紧急数据)
6. Window Size 窗口大小
7. Checksum 校验和
8. Urgent Pointer 紧急指针
9. Options 选项

## 面向有连接 (三次握手)
1. 客户端向服务端发送 SYN 包请求建立连接 (客户端进入 SYN-SENT 状态)
2. 服务端收到 SYN 包后，向客户端发送 SYN+ACK 包确认连接 (服务端进入 SYN-RCVD 状态)
3. 客户端收到 SYN+ACK 包后，向服务端发送 ACK 包确认连接 (客户端进入 ESTABLISHED 状态，服务端接收到 ACK 后也进入 ESTABLISHED 状态)

### 考点：为什么要三次握手才能建立连接，两次行不行？

**两次握手的问题：**
如果只有两次握手，客户端向服务端发送 SYN 包请求建立连接，服务端收到后直接发送 ACK 包确认并进入连接状态。

**为什么不行：**
假设客户端向服务器发送建立连接请求A，但由于网络延迟等原因，请求A超时未到达服务端。TCP启动重传机制，客户端发送新的建立连接请求B，服务端成功收到请求B后返回确认应答并进入连接状态，之后正常传输数据并释放连接。

此时，如果那个延迟的请求A终于到达了服务端，服务端会误以为客户端又要建立新连接，于是返回确认应答并进入连接状态。但此时客户端实际上已经关闭，这会导致服务端一直等待数据传输，造成资源浪费。

三次握手通过第三次确认，确保双方都确认了连接的建立，避免了这种问题。

## 可靠性保证

### 超时重传机制
发送数据包后，如果在规定时间内没有收到确认应答，就会重新发送，直到收到确认应答或超过最大重试次数后放弃发送。

### 拥塞控制
TCP通过以下机制实现拥塞控制：
- **慢启动**：初始时发送少量数据包测试网络环境
- **拥塞避免**：收到确认应答后，逐步增加传输速度和数据包数量
- **快速重传**：网络状况不佳时，及时减少数据包发送速度

这就像道路交通一样，路宽时可以并行多辆车，路窄时只能单车通过，最终目的是减少丢包。

## 有序性保证
每个数据包都有唯一的序列号，接收端根据序列号对数据包进行排序，确保数据的有序性。

## 连接终止 (四次挥手)
1. 客户端向服务端发送 FIN 包，请求关闭连接 (客户端进入 FIN-WAIT-1 状态)
2. 服务端收到 FIN 包后，向客户端发送 ACK 包，确认关闭请求 (服务端进入 CLOSE-WAIT 状态)
3. 服务端发送完剩余数据后，向客户端发送 FIN 包，请求关闭连接 (服务端进入 LAST-ACK 状态)
4. 客户端收到 FIN 包后，向服务端发送 ACK 包，确认关闭连接 (客户端进入 TIME-WAIT 状态，服务端收到后进入 CLOSED 状态)

> **注意**：客户端发送最后一个 ACK 包后进入 TIME-WAIT 状态，等待 2MSL 时间(两个最大报文段生存时间)后才进入 CLOSED 状态，这是为了确保服务端能够收到最后的 ACK 包。
